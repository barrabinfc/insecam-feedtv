(function(){var a,b,c,d,e,f,g,h,i=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},j={}.hasOwnProperty,k=function(a,b){return function(){return a.apply(b,arguments)}};a="webkitAnimationEnd oanimationend msAnimationEnd animationend transitionend",h=function(){return console.log("togglefullscreen"),document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),$("#bt-fullscreen").show()):(document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),$("#bt-fullscreen").hide())},f=null!=f?f:{el:"#cameralist",cycle:{left_time:15e3,left_start:1e3,right_time:15e3,right_start:5e3},camfeed:{url:"assets/cameras.feed.json",feeds:[],fps:1/3}},e=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.defaults={uri:"http://www.error.error/none.mjpeg",country:"None",city:"None"},b}(Backbone.Model),d=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.model=e,b.prototype.localStorage=new Store("CameraFeeds"),b.prototype.historyWeight=[],b.prototype.add=function(a,b){return this.historyWeight.push(1),Backbone.Collection.prototype.add.call(this,a,b),this.trigger("added",a)},b.prototype.pickRandom=function(){var a;return a=chance.pick(this.models)},b.prototype.pickSemiRandom=function(){var a,b,c;return c=chance.weighted(this.models,this.historyWeight),a=this.models.indexOf(c),b=this.historyWeight[a],this.setRandomProbability(c,b/4),c},b.prototype.setRandomProbability=function(a,b){var c;return c=this.models.indexOf(a),console.log("RANDOM: feed "+c+":"+a.get("city")+" = "+b+"%"),this.historyWeight[c]=b},b}(Backbone.Collection),c=function(b){function c(){return this.unrender=k(this.unrender,this),this.hidePhoto=k(this.hidePhoto,this),this.render=k(this.render,this),this.preload=k(this.preload,this),this.autoRefresh=k(this.autoRefresh,this),this.refreshImage=k(this.refreshImage,this),this.cycle=k(this.cycle,this),c.__super__.constructor.apply(this,arguments)}return i(c,b),c.prototype.tagName="section",c.prototype.className="feed-box",c.prototype.refresh_handle=void 0,c.prototype.template=_.template('<div class="feed-stream">\n<img \n    caption="<%= city %>" >\n</div>'),c.prototype.initialize=function(a){return this.name=a,this.model.bind("add",this.render),this.model.bind("change",this.render)},c.prototype.cycle=function(a){return this.model.set("city",a.get("city")),this.model.set("country",a.get("country")),this.model.set("uri",a.get("uri"))},c.prototype.refreshImage=function(){var a,b;return b=this.model.get("uri"),a=b.search("\\?")>0?"&fps=":"?fps=",$("img",this.el).attr("src",b+a+_.random(0,100))},c.prototype.autoRefresh=function(){return null==this.refresh_handle?this.model.get("uri").endsWith(".mjpg")?void 0:(this.refresh_handle=setInterval(this.refreshImage,1e3/f.camfeed.fps),console.log("refresh camera handle: "+this.refresh_handle)):void 0},c.prototype.preload=function(a,b,c){return $("<img/>").on("load",function(a){return function(){return b(a)}}(this)).on("error",function(a){return function(){return c(a)}}(this)).attr("src",a.get("uri"))},c.prototype.render=function(){return null!=this.refresh_handle&&clearInterval,$(this.el).html(this.template(this.model.toJSON())),$("img",this.el).on("load",function(a){return function(){return a.autoRefresh(),$("img",a.el).addClass("visible")}}(this)).on("error",function(a){return function(){return console.log("Failed loading "+a.model.get("uri")),CAMFEEDS.setRandomProbability(a.model,0),a.cycle(CAMFEEDS.pickSemiRandom())}}(this)).attr("src",this.model.get("uri")),this},c.prototype.hidePhoto=function(b){return $("img",this.el).one(a,function(a){return function(c){return $(a).hide(),b()}}(this)).removeClass("visible")},c.prototype.unrender=function(){return null!=this.refresh_handle?clearInterval(this.refresh_handle):void 0},c}(Backbone.View),b=function(a){function b(){return this.cycleCamera=k(this.cycleCamera,this),this.setAutoCycle=k(this.setAutoCycle,this),this.start=k(this.start,this),b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.el="#cameralist",b.prototype.cameras=[],b.prototype.events={"click #bt-cyclecameras":"cycleCameras"},b.prototype.initialize=function(a){return this.settings=a,this.cam_one=CAMFEEDS.pickSemiRandom(),this.cam_two=CAMFEEDS.pickSemiRandom()},b.prototype.start=function(){return this.appendCamera(this.cam_one),this.appendCamera(this.cam_two),this.render()},b.prototype.setAutoCycle=function(){return setTimeout(function(a){return function(){return setInterval(function(){return a.cycleCamera(0)},f.cycle.left_time)}}(this),f.cycle.left_start),setTimeout(function(a){return function(){return setInterval(function(){return a.cycleCamera(1)},f.cycle.right_time)}}(this),f.cycle.right_start)},b.prototype.appendCamera=function(a){var b;return b=new c({model:a}),this.cameras.push(b),$(this.el).append(b.render().el)},b.prototype.cycleCamera=function(a){var b,c;return null==a&&(a=0),b=this.cameras[a],c=CAMFEEDS.pickSemiRandom(),console.group("cyclecamera","Cycling camera "+a+" to "+c.get("uri")),b.preload(c,function(d){return function(){return console.log("Feed "+c.get("uri")+" preloaded correctly. Hiding the current camera("+a+"), and showing the next"),b.cycle(c),b.hidePhoto(function(){return b.cycle(c),console.groupEnd("cyclecamera")})}}(this),function(c){return function(){var c;return c=a,console.error("Cam "+c+":",b.model.get("uri")," - ERROR"),console.groupEnd("cyclecamera"),CAMFEEDS.setRandomProbability(b.model,0),window.app.cycleCamera(c)}}(this))},b.prototype.render=function(){return $(this.el).html()},b}(Backbone.View),g=function(){return window.app.start(),window.app.setAutoCycle(),$("#bt-start").addClass("hidden")},window.CAMFEEDS=[],window.app=null,jQuery(function(){return $.getJSON(f.camfeed.url,function(a){return window.CAMFEEDS=new d,_.each(a,function(a){return function(a){var b;return b=new e(a),window.CAMFEEDS.add(b)}}(this)),window.app=new b(f)}),$("#bt-start").on("click",g),$("#bt-start").focus()})}).call(this);